Bootstrap: docker
From: mambaorg/micromamba:1.5.8

%files
    environment.yml /opt/environment.yml
    get_ref.sh /usr/local/bin/get_ref.sh
    workflow.py /usr/local/bin/workflow.py
    run_workflow.sh /usr/local/bin/run_workflow.sh

%post
    set -e
    echo "== Checking copied files =="
    ls -l /opt/environment.yml
    head -n 5 /opt/environment.yml

    echo "== Creating micromamba env =="
    micromamba create -y -n blast_env -f /opt/environment.yml
    micromamba clean -a -y

    chmod +x /usr/local/bin/get_ref.sh /usr/local/bin/workflow.py /usr/local/bin/run_workflow.sh

%environment
    export MAMBA_ROOT_PREFIX=/opt/conda
    export PATH=/opt/conda/envs/blast_env/bin:$PATH

%runscript
    exec /usr/local/bin/run_workflow.sh "$@"
